-- Function: gpInsertUpdate_Object_Unit()

DROP FUNCTION IF EXISTS gpInsertUpdate_Object_Unit(Integer, Integer, TVarChar, TVarChar, TVarChar, TFloat, TFloat, TFloat, TFloat,
                                                   TDateTime, TDateTime, TDateTime, TDateTime, TDateTime,TDateTime, TDateTime, TDateTime, TDateTime,
                                                   Boolean, Boolean, Integer, Integer, Integer, Integer, Integer, Integer, Integer, Integer, Integer, Integer, Integer, Integer,
                                                   Boolean, Boolean, Boolean, Boolean, Integer, Boolean, Boolean, 
                                                   TVarChar, TVarChar, TVarChar, TDateTime, TDateTime, TDateTime, TDateTime, TDateTime, TDateTime, Boolean, Boolean, Integer, 
                                                   Integer, TVarChar, TVarChar);

CREATE OR REPLACE FUNCTION gpInsertUpdate_Object_Unit(
 INOUT ioId                      Integer   ,   	-- ключ объекта <Подразделение>
    IN inCode                    Integer   ,    -- Код объекта <Подразделение>
    IN inName                    TVarChar  ,    -- Название объекта <Подразделение>
    IN inAddress                 TVarChar  ,    -- адрес
    IN inPhone                   TVarChar  ,

    IN inTaxService              TFloat    ,    -- % от выручки
    IN inTaxServiceNigth         TFloat    ,    -- % от выручки в ночную смену
    IN inKoeffInSUN              TFloat    ,    -- Коэффициент баланса приход/расход
    IN inKoeffOutSUN             TFloat    ,    -- Коэффициент баланса расход/приход
    IN inStartServiceNigth       TDateTime ,
    IN inEndServiceNigth         TDateTime ,
    IN inCreateDate              TDateTime ,    -- дата создания точки
    IN inCloseDate               TDateTime ,    -- дата закрытия точки
    IN inTaxUnitStartDate        TDateTime ,
    IN inTaxUnitEndDate          TDateTime ,
    IN inDateSP                  TDateTime ,    -- Дата начала работы по Соц.проектам 
    IN inStartTimeSP             TDateTime ,    -- Время начала работы по Соц.проектам 
    IN inEndTimeSP               TDateTime ,    -- Время завершения работы по Соц.проектам
    IN inisSp                    Boolean   ,    -- Работают по Соц.проекту
    IN inisRepriceAuto           Boolean   ,    -- участвует в автопереоценке
    IN inAreaId                  Integer   ,    -- регион
    IN inParentId                Integer   ,    -- ссылка на подразделение
    IN inJuridicalId             Integer   ,    -- ссылка на Юридические лицо
    IN inMarginCategoryId        Integer   ,    -- ссылка на категорию наценок
    IN inProvinceCityId          Integer   ,    -- ссылка на Район
    IN inUserManagerId           Integer   ,    -- ссылка на менеджер
    IN inUserManager2Id          Integer   ,    -- ссылка на менеджер 2
    IN inUserManager3Id          Integer   ,    -- ссылка на менеджер 3
    IN inUnitCategoryId          Integer   ,    -- ссылка на категорию 
    IN inUnitRePriceId           Integer   ,    -- ссылка на подразделение 
    IN inNormOfManDays           Integer   ,    -- Норма человекодней в месяце
    IN inPartnerMedicalId        Integer   ,    -- Мед.учреждение для пкму 1303
    IN inPharmacyItem            Boolean   ,    -- Аптечный пункт
    IN inisGoodsCategory         Boolean   ,    -- Для Ассортиментной матрица
    IN inDividePartionDate       Boolean   ,    -- Разбивать товар по партиям на кассах
    IN inRedeemByHandSP          Boolean   ,    -- Погашать через сайт вручную (без использования API)
    IN inUnitOverdueId           Integer   ,    -- Подразделение для перемещения просроченного товара
    IN inisAutoMCS               Boolean   ,    -- Автоматический пересчет НТЗ
    IN inisTopNo                 Boolean   ,    -- Не учитывать ТОП для аптеки

    IN inListDaySUN              TVarChar  ,    -- По каким дням недели по СУН

    IN inLatitude                TVarChar  ,    -- Географическая широта
    IN inLongitude               TVarChar  ,    -- Географическая долгота
    IN inMondayStart             TDateTime ,    -- Пон. -  пятн. начало работы
    IN inMondayEnd               TDateTime ,    -- Пон. -  пятн. конец работы
    IN inSaturdayStart           TDateTime ,    -- Суббота начало работы
    IN inSaturdayEnd             TDateTime ,    -- Суббота конец работы
    IN inSundayStart             TDateTime ,    -- Воскресенье начало работы
    IN inSundayEnd               TDateTime ,    -- Воскресенье конец работы
    IN inisNotCashMCS            Boolean   ,    -- Блокировать изменение НТЗ на кассах 
    IN inisNotCashListDiff       Boolean   ,    -- Блокировать добавление в листы отказов на кассах
    
    IN inUnitOldId               Integer   ,    -- Старое подразделениие (закрытое)
    IN inMorionCode              Integer   ,    -- Код мориона
    IN inAccessKeyYF             TVarChar  ,    -- Ключ ХО для отправки данных Юрия-Фарм

    IN inSession                 TVarChar       -- сессия пользователя
)
RETURNS Integer
AS
$BODY$
   DECLARE vbUserId       Integer;
   DECLARE vbCode_calc    Integer;  
   DECLARE vbOldId        Integer;
   DECLARE vbOldParentId  Integer;
   DECLARE vbCreateDate   TDateTime;
   DECLARE vbCloseDate    TDateTime;
   DECLARE vbFloat        Float;
BEGIN
   -- проверка прав пользователя на вызов процедуры
   -- vbUserId:= lpCheckRight (inSession, zc_Enum_Process_InsertUpdate_Object_Unit());
   vbUserId:= lpGetUserBySession (inSession);

   -- Если код не установлен, определяем его как последний+1 (!!! ПОТОМ НАДО БУДЕТ ЭТО ВКЛЮЧИТЬ !!!)
   vbCode_calc:= lfGet_ObjectCode (inCode, zc_Object_Unit());
   -- !!! IF COALESCE (inCode, 0) = 0  THEN vbCode_calc := NULL; ELSE vbCode_calc := inCode; END IF; -- !!! А ЭТО УБРАТЬ !!!
   
   if COALESCE((SELECT ObjectBoolean.ValueData FROM ObjectBoolean WHERE ObjectBoolean.DescId = zc_ObjectBoolean_Unit_DividePartionDate() and 
      ObjectBoolean.ObjectId = ioId), False) <> inDividePartionDate
     AND NOT EXISTS (SELECT UserId FROM ObjectLink_UserRole_View WHERE UserId = vbUserId AND RoleId = zc_Enum_Role_Admin())
   THEN
      RAISE EXCEPTION 'Ошибка.Изменение признака <Разбивать товар по партиям на кассах> разрешено только администратору.';   
   END IF;
   
   IF TRIM(inLatitude) <> ''
   THEN
     BEGIN
          vbFloat:= TRIM(inLatitude) :: Float;
     EXCEPTION           
        WHEN data_exception
        THEN vbFloat := -1;
        RAISE EXCEPTION 'Ошибка.Ошибка широт <%> невозможно преобразовать в число.', inLatitude;   
     END;
   END IF;

   IF TRIM(inLongitude) <> ''
   THEN
     BEGIN
          vbFloat:= TRIM(inLongitude) :: Float;
     EXCEPTION           
        WHEN data_exception
        THEN vbFloat := -1;
        RAISE EXCEPTION 'Ошибка.Ошибка долгота <%> невозможно преобразовать в число.', inLongitude;   
     END;
   END IF;

   
   -- проверка уникальности <Наименование>
   PERFORM lpCheckUnique_Object_ValueData (ioId, zc_Object_Unit(), inName);
   -- проверка уникальности <Код>
   PERFORM lpCheckUnique_Object_ObjectCode (ioId, zc_Object_Unit(), vbCode_calc);

   -- проверка цикл у дерева
   PERFORM lpCheck_Object_CycleLink(ioId, zc_ObjectLink_Unit_Parent(), inParentId);

   -- сохранили
   vbOldId:= ioId;
   -- сохранили
   vbOldParentId:= (SELECT ChildObjectId FROM ObjectLink WHERE DescId = zc_ObjectLink_Unit_Parent() AND ObjectId = ioId);

   -- сохранили объект
   ioId := lpInsertUpdate_Object (ioId, zc_Object_Unit(), vbCode_calc, inName, inAccessKeyId:= NULL);

   -- сохранили связь с <Подразделения>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_Parent(), ioId, inParentId);

   -- сохранили связь с <Юридические лица>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_Juridical(), ioId, inJuridicalId);

   -- сохранили связь с <Категория наценок>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_MarginCategory(), ioId, inMarginCategoryId);

   -- сохранили связь с <Районом>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_ProvinceCity(), ioId, inProvinceCityId);
   
   -- сохранили связь с <Категорией>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_Category(), ioId, inUnitCategoryId);

   -- адрес
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_Address(), ioId, inAddress);

   -- телефон
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_Phone(), ioId, inPhone);

   -- По каким дням недели по СУН
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_ListDaySUN(), ioId, inListDaySUN);

   -- % бонусирования
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_TaxService(), ioId, inTaxService);
   -- % ночной
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_TaxServiceNigth(), ioId, inTaxServiceNigth);

   -- Коэффициент баланса приход/расход
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_KoeffInSUN(), ioId, inKoeffInSUN);
   -- Коэффициент баланса расход/приход
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_KoeffOutSUN(), ioId, inKoeffOutSUN);

   IF inStartServiceNigth ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_StartServiceNigth(), ioId, inStartServiceNigth);
   END IF;
   IF inEndServiceNigth ::Time <> '00:00'
   THEN   
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_EndServiceNigth(), ioId, inEndServiceNigth);
   END IF;

   IF inTaxUnitStartDate ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_TaxUnitStart(), ioId, inTaxUnitStartDate);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_TaxUnitStart(), ioId, NULL);
   END IF;
   IF inTaxUnitEndDate ::Time <> '00:00'
   THEN   
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_TaxUnitEnd(), ioId, inTaxUnitEndDate);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_TaxUnitEnd(), ioId, NULL);
   END IF;

   -- сохранили свойство <>
   PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_StartSP(), ioId, inStartTimeSP);
   -- сохранили свойство <>
   PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_EndSP(), ioId, inEndTimeSP);
     
   IF inisSp = TRUE
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SP(), ioId, inDateSP);
   ELSE 
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SP(), ioId, NULL);
   END IF;

   --
   PERFORM lpInsertUpdate_ObjectBoolean (zc_ObjectBoolean_Unit_SP(), ioId, inisSP);
   
   -- участвует в автопереоценке
   PERFORM lpInsertUpdate_ObjectBoolean (zc_ObjectBoolean_Unit_RepriceAuto(), ioId, inisRepriceAuto);

   -- Если добавляли подразделение
   IF vbOldId <> ioId THEN
      -- Установить свойство лист\папка у себя
      PERFORM lpInsertUpdate_ObjectBoolean (zc_ObjectBoolean_isLeaf(), ioId, TRUE);
   END IF;

   -- Точно теперь inParentId стал папкой 
   IF COALESCE (inParentId, 0) <> 0 THEN
      PERFORM lpInsertUpdate_ObjectBoolean (zc_ObjectBoolean_isLeaf(), inParentId, FALSE);
   END IF;

   IF COALESCE (vbOldParentId, 0) <> 0 THEN
      PERFORM lpUpdate_isLeaf (vbOldParentId, zc_ObjectLink_Unit_Parent());
   END IF;
   
   -- сохранили связь с <менеджер>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UserManager(), ioId, inUserManagerId);
   -- сохранили связь с <менеджер 2>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UserManager2(), ioId, inUserManager2Id);
   -- сохранили связь с <менеджер 3>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UserManager3(), ioId, inUserManager3Id);

   -- сохранили связь с <Регион>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_Area(), ioId, inAreaId);

   -- сохранили связь с подразделением
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UnitRePrice(), ioId, inUnitRePriceId);
   
   -- сохранили связь с <>
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_PartnerMedical(), ioId, inPartnerMedicalId);

   IF inCreateDate <> (CURRENT_DATE + INTERVAL '1 DAY')
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_Create(), ioId, inCreateDate);
   ELSE 
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_Create(), ioId, NULL);
   END IF;

   IF inCloseDate <> (CURRENT_DATE + INTERVAL '1 DAY')
   THEN   
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_Close(), ioId, inCloseDate);
   ELSE 
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_Close(), ioId, NULL);
   END IF;
   
   -- Норма человекодней в месяце
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_NormOfManDays(), ioId, inNormOfManDays);

   --сохранили <Аптечный пункт>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_PharmacyItem(), ioId, inPharmacyItem);
   --сохранили <>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_GoodsCategory(), ioId, inisGoodsCategory);

   --сохранили <>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_DividePartionDate(), ioId, inDividePartionDate);
   --сохранили <>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_RedeemByHandSP(), ioId, inRedeemByHandSP);

   -- сохранили связь с подразделением
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UnitOverdue(), ioId, inUnitOverdueId);

   -- сохранили связь с подразделением
   PERFORM lpInsertUpdate_ObjectLink(zc_ObjectLink_Unit_UnitOld(), ioId, inUnitOldId);

   --сохранили <>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_AutoMCS(), ioId, inisAutoMCS);

   --сохранили <>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_TopNo(), ioId, inisTopNo);
   
   
   -- Географическая широта
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_Latitude(), ioId, TRIM(inLatitude));
   -- Географическая долгота
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_Longitude(), ioId, TRIM(inLongitude));

   -- Код мориона
   PERFORM lpInsertUpdate_ObjectFloat(zc_ObjectFloat_Unit_MorionCode(), ioId, inMorionCode);
   -- Ключ ХО для отправки данных Юрия-Фарм
   PERFORM lpInsertUpdate_ObjectString(zc_ObjectString_Unit_AccessKeyYF(), ioId, TRIM(inAccessKeyYF));

   IF inMondayStart ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_MondayStart(), ioId, inMondayStart);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_MondayStart(), ioId, NULL);
   END IF;
   
   IF inMondayEnd ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_MondayEnd(), ioId, inMondayEnd);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_MondayEnd(), ioId, NULL);
   END IF;

   IF inSaturdayStart ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SaturdayStart(), ioId, inSaturdayStart);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SaturdayStart(), ioId, NULL);
   END IF;

   IF inSaturdayEnd ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SaturdayEnd(), ioId, inSaturdayEnd);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SaturdayEnd(), ioId, NULL);
   END IF;

   IF inSundayStart ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SundayStart(), ioId, inSundayStart);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SundayStart(), ioId, NULL);
   END IF;

   IF inSundayEnd ::Time <> '00:00'
   THEN
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SundayEnd(), ioId, inSundayEnd);
   ELSE
       -- сохранили свойство <>
       PERFORM lpInsertUpdate_ObjectDate (zc_ObjectDate_Unit_SundayEnd(), ioId, NULL);
   END IF;
   
   --сохранили <Блокировать изменение НТЗ на кассах>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_NotCashMCS(), ioId, inisNotCashMCS);
   --сохранили <Блокировать добавление в листы отказов на кассах>
   PERFORM lpInsertUpdate_ObjectBoolean(zc_ObjectBoolean_Unit_NotCashListDiff(), ioId, inisNotCashListDiff);   

   -- сохранили протокол
   PERFORM lpInsert_ObjectProtocol (ioId, vbUserId);


END;$BODY$

LANGUAGE plpgsql VOLATILE;


-------------------------------------------------------------------------------
/*
 ИСТОРИЯ РАЗРАБОТКИ: ДАТА, АВТОР
               Фелонюк И.В.   Кухтин И.В.   Климентьев К.И.   Шаблий О.В.
 13.12.19                                                       * MorionCode, AccessKeyYF
 11.12.19                                                       * UnitOld
 24.11.19                                                       * isNotCashMCS, isNotCashListDiff
 20.11.19         * inListDaySUN
 28.10.19                                                        * Координаты и графики
 04.09.19         * inisTopNo
 26.08.19         * inKoeffInSUN, inKoeffOutSUN
 13.08.19                                                        * AutoMCS
 02.07.19                                                        * UnitOverdue
 02.07.19         *
 14.06.19                                                        *
 20.03.19         *
 15.02.19         * inGoodsCategory
 09.02.19                                                        * add PharmacyItem
 15.01.19         *
 22.10.18         *
 29.08.18         * Phone
 14.05.18                                                        * add NormOfManDays               
 05.05.18                                                        * add UnitCategory               
 20.09.17         * add area
 15.09.17         * 
 08.08.17         * add ProvinceCity
 06.03.17         * add Address
 08.04.16         *
 24.02.16         * 
 14.02.16         * 
 27.06.14         * 
 25.06.13                          *

*/

-- тест
-- SELECT * FROM gpInsertUpdate_Object_Unit ()                            
