-- Function: lpComplete_Movement_Currency()

DROP FUNCTION IF EXISTS lpComplete_Movement_Currency (Integer, Integer);

CREATE OR REPLACE FUNCTION lpComplete_Movement_Currency(
    IN inMovementId        Integer  , -- ключ ƒокумента
    IN inUserId            Integer    -- ѕользователь
)
 RETURNS VOID
AS
$BODY$
  DECLARE vbOperDate TDateTime;
  DECLARE vbStatusId Integer;
  DECLARE vbCurrencyId Integer;
  DECLARE vbPaidKindId Integer;
  DECLARE vbCurrencyValue TFloat;
  DECLARE vbParValue TFloat;
BEGIN
     -- !!!об€зательно!!! очистили таблицу проводок
     DELETE FROM _tmpMIContainer_insert;
     DELETE FROM _tmpMIReport_insert;
     -- !!!об€зательно!!! очистили таблицу - элементы документа, со всеми свойствами дл€ формировани€ јналитик в проводках
     DELETE FROM _tmpItem;


     -- Ёти параметры нужны дл€ расчета Remains
     SELECT Movement.OperDate                AS OperDate
          , Movement.StatusId                AS StatusId
          , MILinkObject_CurrencyTo.ObjectId AS CurrencyId
          , MILinkObject_PaidKind.ObjectId   AS PaidKindId
          , MovementItem.Amount              AS CurrencyValue
          , MIFloat_ParValue.ValueData       AS ParValue
            INTO vbOperDate, vbStatusId, vbCurrencyId, vbPaidKindId
               , vbCurrencyValue, vbParValue
     FROM Movement
          INNER JOIN MovementItem ON MovementItem.MovementId = Movement.Id
                                 AND MovementItem.ObjectId = zc_Enum_Currency_Basis()
          LEFT JOIN MovementItemFloat AS MIFloat_ParValue
                                      ON MIFloat_ParValue.MovementItemId = MovementItem.Id
                                     AND MIFloat_ParValue.DescId = zc_MIFloat_ParValue()
          LEFT JOIN MovementItemLinkObject AS MILinkObject_CurrencyTo
                                           ON MILinkObject_CurrencyTo.MovementItemId = MovementItem.Id
                                          AND MILinkObject_CurrencyTo.DescId = zc_MILinkObject_Currency()
          LEFT JOIN MovementItemLinkObject AS MILinkObject_PaidKind
                                       ON MILinkObject_PaidKind.MovementItemId = MovementItem.Id
                                      AND MILinkObject_PaidKind.DescId = zc_MILinkObject_PaidKind()
     WHERE Movement.Id = inMovementId
       AND Movement.DescId = zc_Movement_Currency()
       AND Movement.StatusId IN (zc_Enum_Status_UnComplete(), zc_Enum_Status_Erased());


     IF vbStatusId <> zc_Enum_Status_Complete()
     THEN
        -- –асчет Remains и запись его в zc_MI_Child
        PERFORM lpInsertUpdate_MovementItemFloat (zc_MIFloat_ContainerId(), tmp.MovementItemId, tmp.ContainerId)
        FROM
       (SELECT lpInsertUpdate_MovementItem (COALESCE (MovementItem.Id, 0), zc_MI_Child(), COALESCE (tmpSumm.ObjectId, MovementItem.ObjectId), inMovementId, COALESCE (tmpSumm.OperSumm, 0), NULL) AS MovementItemId
             , COALESCE (tmpSumm.ContainerId, MovementItem.ContainerId) AS ContainerId
        FROM (SELECT MovementItem.Id, MovementItem.ObjectId, MIFloat_ContainerId.ValueData AS ContainerId
              FROM MovementItem
                   LEFT JOIN MovementItemFloat AS MIFloat_ContainerId
                                               ON MIFloat_ContainerId.MovementItemId = MovementItem.Id
                                              AND MIFloat_ContainerId.DescId = zc_MIFloat_ContainerId()
              WHERE MovementItem.MovementId = inMovementId
                AND MovementItem.DescId = zc_MI_Child()
             ) AS MovementItem
             FULL JOIN (SELECT tmpSumm.ContainerId
                             , tmpSumm.ObjectId
                             , SUM (tmpSumm.OperSumm) AS OperSumm
                         FROM
                         -- это суммы в ¬алюте (их надо перевести в валюту баланса и прибавить)
                        (SELECT tmpContainer.ContainerId
                              , tmpContainer.AccountId
                              , tmpContainer.ObjectId
                              , CAST ((tmpContainer.Amount - COALESCE (SUM (MIContainer.Amount), 0))
                                       -- так переводитс€ в валюту баланса
                                     * CASE WHEN vbParValue = 0 THEN 0 ELSE vbCurrencyValue / vbParValue END
                                AS NUMERIC (16, 2)) AS OperSumm
                         FROM (SELECT Container.ParentId                       AS ContainerId
                                    , ContainerLinkObject_Currency.ContainerId AS ContainerId_Currency
                                    , Container.ObjectId                       AS AccountId
                                    , COALESCE (ContainerLinkObject_Cash.ObjectId, COALESCE (ContainerLinkObject_BankAccount.ObjectId, COALESCE (ContainerLinkObject_Partner.ObjectId, COALESCE (ContainerLinkObject_Juridical.ObjectId, 0)))) AS ObjectId
                                    , Container.Amount
                               FROM ContainerLinkObject AS ContainerLinkObject_Currency
                                    INNER JOIN Container ON Container.Id = ContainerLinkObject_Currency.ContainerId
                                                        AND Container.DescId  = zc_Container_SummCurrency()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Cash
                                                                  ON ContainerLinkObject_Cash.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Cash.DescId  = zc_ContainerLinkObject_Cash()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_BankAccount
                                                                  ON ContainerLinkObject_BankAccount.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_BankAccount.DescId  = zc_ContainerLinkObject_BankAccount()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Partner
                                                                  ON ContainerLinkObject_Partner.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Partner.DescId  = zc_ContainerLinkObject_Partner()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Juridical
                                                                  ON ContainerLinkObject_Juridical.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Juridical.DescId  = zc_ContainerLinkObject_Juridical()
                               WHERE ContainerLinkObject_Currency.ObjectId = vbCurrencyId
                                 AND ContainerLinkObject_Currency.DescId  = zc_ContainerLinkObject_Currency()
                              ) AS tmpContainer
                              LEFT JOIN MovementItemContainer AS MIContainer
                                                              ON MIContainer.Containerid = tmpContainer.ContainerId_Currency
                                                             AND MIContainer.OperDate >= vbOperDate
                         GROUP BY tmpContainer.ContainerId
                                , tmpContainer.ContainerId_Currency
                                , tmpContainer.AccountId
                                , tmpContainer.ObjectId
                                , tmpContainer.Amount
                       UNION ALL
                         -- это суммы в валюте баланса (их надо вычесть)
                         SELECT tmpContainer.ContainerId
                              , tmpContainer.AccountId
                              , tmpContainer.ObjectId
                              , -1 * (tmpContainer.Amount - COALESCE (SUM (MIContainer.Amount), 0)) AS OperSumm
                         FROM (SELECT ContainerLinkObject_Currency.ContainerId
                                    , Container.ObjectId AS AccountId
                                    , COALESCE (ContainerLinkObject_Cash.ObjectId, COALESCE (ContainerLinkObject_BankAccount.ObjectId, COALESCE (ContainerLinkObject_Partner.ObjectId, COALESCE (ContainerLinkObject_Juridical.ObjectId, 0)))) AS ObjectId
                                    , Container.Amount
                               FROM ContainerLinkObject AS ContainerLinkObject_Currency
                                    INNER JOIN Container ON Container.Id = ContainerLinkObject_Currency.ContainerId
                                                        AND Container.DescId  = zc_Container_Summ()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Cash
                                                                  ON ContainerLinkObject_Cash.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Cash.DescId  = zc_ContainerLinkObject_Cash()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_BankAccount
                                                                  ON ContainerLinkObject_BankAccount.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_BankAccount.DescId  = zc_ContainerLinkObject_BankAccount()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Partner
                                                                  ON ContainerLinkObject_Partner.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Partner.DescId  = zc_ContainerLinkObject_Partner()
                                    LEFT JOIN ContainerLinkObject AS ContainerLinkObject_Juridical
                                                                  ON ContainerLinkObject_Juridical.ContainerId  = ContainerLinkObject_Currency.ContainerId
                                                                 AND ContainerLinkObject_Juridical.DescId  = zc_ContainerLinkObject_Juridical()
                               WHERE ContainerLinkObject_Currency.ObjectId = vbCurrencyId
                                 AND ContainerLinkObject_Currency.DescId  = zc_ContainerLinkObject_Currency()
                              ) AS tmpContainer
                              LEFT JOIN MovementItemContainer AS MIContainer
                                                              ON MIContainer.Containerid = tmpContainer.ContainerId
                                                             AND MIContainer.OperDate >= vbOperDate
                         GROUP BY tmpContainer.ContainerId
                                , tmpContainer.AccountId
                                , tmpContainer.ObjectId
                                , tmpContainer.Amount
                        ) AS tmpSumm
                         GROUP BY tmpSumm.ContainerId
                                , tmpSumm.ObjectId
                        ) AS tmpSumm ON tmpSumm.ContainerId = MovementItem.ContainerId
       ) AS tmp;

     END IF; -- if vbStatusId <> zc_Enum_Status_Complete()


     -- заполн€ем таблицу - элементы документа, со всеми свойствами дл€ формировани€ јналитик в проводках
     INSERT INTO _tmpItem (MovementDescId, OperDate, ObjectId, ObjectDescId, OperSumm
                         , MovementItemId, ContainerId
                         , AccountGroupId, AccountDirectionId, AccountId
                         , ProfitLossGroupId, ProfitLossDirectionId
                         , InfoMoneyGroupId, InfoMoneyDestinationId, InfoMoneyId
                         , BusinessId_Balance, BusinessId_ProfitLoss, JuridicalId_Basis
                         , UnitId, PositionId, BranchId_Balance, BranchId_ProfitLoss, ServiceDateId, ContractId, PaidKindId
                         , IsActive, IsMaster
                          )
        SELECT Movement.DescId
             , Movement.OperDate
             , COALESCE (MovementItem.ObjectId, 0) AS ObjectId
             , COALESCE (Object.DescId, 0) AS ObjectDescId
             , MovementItem.Amount AS OperSumm
             , MovementItem.Id AS MovementItemId

             , COALESCE (MIFloat_ContainerId.ValueData, 0) AS ContainerId           -- есть значение
             , 0 AS AccountGroupId, 0 AS AccountDirectionId                         -- не используетс€
             , COALESCE (Container.ObjectId, 0) AS AccountId                        -- есть значение
             , 0 AS ProfitLossGroupId, 0 AS ProfitLossDirectionId                   -- не используетс€

               -- ”правленческие группы назначени€: не используетс€
             , 0 AS InfoMoneyGroupId
               -- ”правленческие назначени€: не используетс€
             , 0 AS InfoMoneyDestinationId
               -- ”правленческие статьи назначени€: не используетс€
             , 0 AS InfoMoneyId

               -- Ѕизнес Ѕаланс: не используетс€
             , 0 AS BusinessId_Balance
               -- Ѕизнес ќѕи”: не используетс€
             , 0 AS BusinessId_ProfitLoss

               -- √лавное ёр.лицо: всегда из ...
             , ContainerLinkObject_JuridicalBasis.ObjectId AS JuridicalId_Basis

             , 0 AS UnitId     -- не используетс€
             , 0 AS PositionId -- не используетс€

               -- ‘илиал Ѕаланс: не используетс€
             , 0 AS BranchId_Balance
               -- ‘илиал ќѕи”: не используетс€
             , 0 AS BranchId_ProfitLoss

               -- ћес€ц начислений: не используетс€
             , 0 AS ServiceDateId

             , 0 AS ContractId -- не используетс€
             , 0 AS PaidKindId -- не используетс€

             , CASE WHEN MovementItem.Amount >= 0 THEN TRUE ELSE FALSE END AS IsActive
             , TRUE AS IsMaster

        FROM Movement
             INNER JOIN MovementItem ON MovementItem.MovementId = Movement.Id
                                    AND MovementItem.DescId = zc_MI_Child()
                                    AND MovementItem.Amount <> 0
             LEFT JOIN MovementItemFloat AS MIFloat_ContainerId
                                         ON MIFloat_ContainerId.MovementItemId = MovementItem.Id
                                        AND MIFloat_ContainerId.DescId = zc_MIFloat_ContainerId()
             LEFT JOIN Object ON Object.Id = MovementItem.ObjectId
             LEFT JOIN Container ON Container.Id = MIFloat_ContainerId.ValueData
             LEFT JOIN ContainerLinkObject AS ContainerLinkObject_JuridicalBasis
                                           ON ContainerLinkObject_JuridicalBasis.ContainerId = Container.Id
                                          AND ContainerLinkObject_JuridicalBasis.DescId  = zc_ContainerLinkObject_JuridicalBasis()
        WHERE Movement.Id = inMovementId
          AND Movement.DescId = zc_Movement_Currency()
          AND Movement.StatusId IN (zc_Enum_Status_UnComplete(), zc_Enum_Status_Erased())
       ;


     -- заполн€ем таблицу - элементы документа, со всеми свойствами дл€ формировани€ јналитик в проводках
     INSERT INTO _tmpItem (MovementDescId, OperDate, ObjectId, ObjectDescId, OperSumm
                         , MovementItemId, ContainerId
                         , AccountGroupId, AccountDirectionId, AccountId
                         , ProfitLossGroupId, ProfitLossDirectionId
                         , InfoMoneyGroupId, InfoMoneyDestinationId, InfoMoneyId
                         , BusinessId_Balance, BusinessId_ProfitLoss, JuridicalId_Basis
                         , UnitId, PositionId, BranchId_Balance, BranchId_ProfitLoss, ServiceDateId, ContractId, PaidKindId
                         , IsActive, IsMaster
                          )
        SELECT _tmpItem.MovementDescId
             , _tmpItem.OperDate
             , 0 AS ObjectId
             , 0 AS ObjectDescId
             , -1 * _tmpItem.OperSumm
             , _tmpItem.MovementItemId

             , 0 AS ContainerId                                               -- сформируем позже
             , 0 AS AccountGroupId, 0 AS AccountDirectionId, 0 AS AccountId   -- сформируем позже

               -- √руппы ќѕи”: не используетс€
             , 0 AS ProfitLossGroupId
               -- јналитики ќѕи” - направлени€: не используетс€
             , 0 AS ProfitLossDirectionId

               -- ”правленческие группы назначени€: не используетс€
             , 0 AS InfoMoneyGroupId
               -- ”правленческие назначени€: не используетс€
             , 0 AS InfoMoneyDestinationId
               -- ”правленческие статьи назначени€: не используетс€
             , 0 AS InfoMoneyId

               -- Ѕизнес Ѕаланс: не используетс€
             , 0 AS BusinessId_Balance
               -- Ѕизнес ќѕи”: всегда 0
             , 0 AS BusinessId_ProfitLoss

               -- √лавное ёр.лицо: всегда из ...
             , _tmpItem.JuridicalId_Basis

             , 0 AS UnitId     -- не используетс€
             , 0 AS PositionId -- не используетс€

               -- ‘илиал Ѕаланс: не используетс€
             , 0 AS BranchId_Balance
               -- ‘илиал ќѕи”: не используетс€
             , 0 AS BranchId_ProfitLoss

               -- ћес€ц начислений: не используетс€
             , 0 AS ServiceDateId

             , 0 AS ContractId -- не используетс€
             , 0 AS PaidKindId -- не используетс€

             , NOT _tmpItem.IsActive
             , NOT _tmpItem.IsMaster
        FROM _tmpItem
       ;


     -- 5.1. ‘»Ќ»Ў - формируем/сохран€ем ѕроводки
     PERFORM lpComplete_Movement_Finance (inMovementId := inMovementId
                                        , inUserId     := inUserId);

-- RAISE EXCEPTION 'ok' ;
     -- 5.2. ‘»Ќ»Ў - ќб€зательно мен€ем статус документа + сохранили протокол
     PERFORM lpComplete_Movement (inMovementId := inMovementId
                                , inDescId     := zc_Movement_Currency()
                                , inUserId     := inUserId
                                 );
END;
$BODY$
  LANGUAGE plpgsql VOLATILE;

/*
 »—“ќ–»я –ј«–јЅќ“ »: ƒј“ј, ј¬“ќ–
               ‘елонюк ».¬.    ухтин ».¬.    лиментьев  .».   ћанько ƒ.ј.
 13.11.14                                        *
*/

-- тест
-- SELECT * FROM lpComplete_Movement_Currency (inMovementId:= 10154, inUserId:= zfCalc_UserAdmin() :: Integer)
