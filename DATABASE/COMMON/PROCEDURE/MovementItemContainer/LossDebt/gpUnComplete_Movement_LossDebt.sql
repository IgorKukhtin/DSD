-- Function: gpUnComplete_Movement_LossDebt (Integer, TVarChar)

DROP FUNCTION IF EXISTS gpUnComplete_Movement_LossDebt (Integer, TVarChar);

CREATE OR REPLACE FUNCTION gpUnComplete_Movement_LossDebt(
    IN inMovementId        Integer               , -- ключ Документа
    IN inSession           TVarChar DEFAULT ''     -- сессия пользователя
)                              
RETURNS VOID
AS
$BODY$
  DECLARE vbUserId Integer;
BEGIN
     -- проверка прав пользователя на вызов процедуры
     vbUserId:= lpCheckRight (inSession, zc_Enum_Process_UnComplete_LossDebt());

     IF inMovementId = 123096 -- № 15 от 31.12.2013
     OR inMovementId = 19270690 -- № 259 от 28.02.2021
     THEN
         RAISE EXCEPTION 'Ошибка.Документ не может быть распроведен.';
     END IF;

     -- Распроводим Документ
     PERFORM lpUnComplete_Movement (inMovementId := inMovementId
                                  , inUserId     := vbUserId);

END;
$BODY$
  LANGUAGE plpgsql VOLATILE;

/*
 ИСТОРИЯ РАЗРАБОТКИ: ДАТА, АВТОР
               Фелонюк И.В.   Кухтин И.В.   Климентьев К.И.   Манько Д.
 30.01.14         *
*/
/*
-- № 259 от 28.02.2021
22709334171;2;19270690;1053932;9000.0000;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334170;2;19270690;2291417;-9000.0000;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9165;;;1053932;;;;9210
22709334169;2;19270690;1053932;772.0700;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334168;2;19270690;284607;-772.0700;"2021-02-28 00:00:00+02";196231543;;t;26;437042;326309;;;1053932;;;;9210
22709334167;2;19270690;1053932;200.0000;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334166;2;19270690;2436144;-200.0000;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9163;;;1053932;;;;9210
22709334165;2;19270690;1053932;-2107.4524;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334164;2;19270690;2575161;2107.4524;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334163;2;19270690;1053932;-1761.0892;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334162;2;19270690;2613783;1761.0892;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334161;2;19270690;1053932;-1450.6305;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334160;2;19270690;3188620;1450.6305;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334159;2;19270690;1053932;-1381.8508;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334158;2;19270690;2816762;1381.8508;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334157;2;19270690;1053932;-986.2012;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334156;2;19270690;2710486;986.2012;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334155;2;19270690;1053932;-870.2915;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334154;2;19270690;3368090;870.2915;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334153;2;19270690;1053932;-614.9921;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334152;2;19270690;3153336;614.9921;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334151;2;19270690;1053932;-578.8382;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334150;2;19270690;3188624;578.8382;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
22709334149;2;19270690;1053932;6889.5082;"2021-02-28 00:00:00+02";196231543;;f;26;;9210;;;;;;;
22709334148;2;19270690;2436145;-6889.5082;"2021-02-28 00:00:00+02";196231543;;t;26;437042;9164;;;1053932;;;;9210
*/
-- тест
-- SELECT * FROM gpUnComplete_Movement_LossDebt (inMovementId:= 149639, inSession:= zfCalc_UserAdmin())
