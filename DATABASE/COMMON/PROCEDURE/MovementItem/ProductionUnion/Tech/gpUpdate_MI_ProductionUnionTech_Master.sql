-- Function: gpUpdate_MI_ProductionUnionTech_Master()

DROP FUNCTION IF EXISTS gpUpdate_MI_ProductionUnionTech_Master (Integer, Integer, Integer, Integer, Integer, TFloat, TFloat, TVarChar, TVarChar);

CREATE OR REPLACE FUNCTION gpUpdate_MI_ProductionUnionTech_Master(
    IN inMovementItemId_order Integer   , -- Ключ объекта <Элемент документа>
 INOUT ioMovementItemId       Integer   , -- Ключ объекта <Элемент документа>
 INOUT ioMovementId           Integer   , -- Ключ объекта <Документ>
    IN inReceiptId            Integer   , -- Рецептуры
    IN inGoodsId              Integer   , -- Товар - !!!только для проверки inReceiptId!!!
    IN inCount	              TFloat    , -- Количество батонов или упаковок
    IN inRealWeight           TFloat    , -- Фактический вес(информативно)
    IN inComment              TVarChar  , -- Примечание
    IN inSession              TVarChar    -- сессия пользователя
)
RETURNS RECORD
AS
$BODY$
   DECLARE vbUserId Integer;
BEGIN
   -- проверка прав пользователя на вызов процедуры
   vbUserId:= lpCheckRight (inSession, zc_Enum_Process_InsertUpdate_MI_ProductionUnionTech_Master());


   -- проверка - если не нашли ioMovementItemId + ioMovementId
   IF ioMovementId <> 0 AND NOT EXISTS (SELECT Id FROM MovementItem WHERE Id = ioMovementItemId AND MovementId = ioMovementId)
   THEN
       RAISE EXCEPTION 'Ошибка.MovementId.';
   END IF;

   -- если это элемент - заявка
   IF NOT EXISTS (SELECT MovementItem.Id FROM MovementItem INNER JOIN Movement ON Movement.Id = MovementItem.MovementId AND Movement.DescId = zc_Movement_ProductionUnion() WHERE MovementItem.Id = ioMovementItemId)
   THEN
       RAISE EXCEPTION 'Ошибка.Данные по <Закладке> не сформированы.';
   END IF;

   -- проверка
   IF COALESCE (inReceiptId, 0) = 0
   THEN
       RAISE EXCEPTION 'Ошибка.Значение <Название рецептуры> не установлено.';
   END IF;

   -- проверка
   IF NOT EXISTS (SELECT ObjectId FROM ObjectLink  WHERE ChildObjectId = inGoodsId AND ObjectId = inReceiptId AND DescId = zc_ObjectLink_Receipt_Goods())
   THEN
       RAISE EXCEPTION 'Ошибка.Для товара <%> не может быть выбрана рецептура <%>.', lfGet_Object_ValueData (inGoodsId), lfGet_Object_ValueData (inReceiptId);
   END IF;

   -- проверка - если изменилась <Рецептура>
   IF COALESCE (inReceiptId, 0) <> COALESCE ((SELECT ObjectId FROM MovementItemLinkObject WHERE MovementItemId = ioMovementItemId AND DescId = zc_MILinkObject_Receipt()), 0)
      AND EXISTS (SELECT MovementId FROM MovementItem WHERE MovementId = ioMovementId AND DescId = zc_MI_Child())
   THEN
       RAISE EXCEPTION 'Ошибка.Найдены данные по <Закладке>.Значение <Название рецептуры> изменять нельзя.';
   END IF;


   -- сохранили связь с <Рецептуры>
   PERFORM lpInsertUpdate_MovementItemLinkObject(zc_MILinkObject_Receipt(), ioMovementItemId, inReceiptId);

   -- сохранили свойство <Количество батонов>
   PERFORM lpInsertUpdate_MovementItemFloat(zc_MIFloat_Count(), ioMovementItemId, inCount);
   -- сохранили свойство <Фактический вес(информативно)>
   PERFORM lpInsertUpdate_MovementItemFloat(zc_MIFloat_RealWeight(), ioMovementItemId, inRealWeight);

   -- сохранили свойство <Примечание>
   PERFORM lpInsertUpdate_MovementItemString(zc_MIString_Comment(), ioMovementItemId, inComment);


   -- !!!сохранили св-ва <Рецептуры> у заявки!!!
   IF inMovementItemId_order <> 0
   THEN
       PERFORM lpInsertUpdate_MovementItemLinkObject (zc_MILinkObject_Receipt(), inMovementItemId_order, inReceiptId);
   END IF;

   -- сохранили связь с <>
   PERFORM lpInsertUpdate_MovementItemLinkObject (zc_MILinkObject_Update(), ioMovementItemId, vbUserId);
   -- сохранили свойство <>
   PERFORM lpInsertUpdate_MovementItemDate (zc_MIDate_Update(), ioMovementItemId, CURRENT_TIMESTAMP);

   -- сохранили протокол
   PERFORM lpInsert_MovementItemProtocol (ioMovementItemId, vbUserId, FALSE);


END;
$BODY$
  LANGUAGE plpgsql VOLATILE;

/*
 ИСТОРИЯ РАЗРАБОТКИ: ДАТА, АВТОР
               Фелонюк И.В.   Кухтин И.В.   Климентьев К.И.   Манько Д.А.
 21.03.15                                        *all
 19.12.14                                                       * add zc_MILinkObject_GoodsKindComplete
 12.12.14                                                       *
*/

-- тест
-- SELECT * FROM gpUpdate_MI_ProductionUnionTech_Master (ioId:= 0, ioMovementId:= 10, inGoodsId:= 1, inAmount:= 0, inPartionClose:= FALSE, inComment:= '', inCount:= 1, inRealWeight:= 1, inCuterCount:= 0, inReceiptId:= 0, inSession:= '2')
