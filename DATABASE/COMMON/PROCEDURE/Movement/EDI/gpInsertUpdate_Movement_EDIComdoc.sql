-- Function: gpInsertUpdate_Movement_EDI()

DROP FUNCTION IF EXISTS gpInsertUpdate_Movement_EDIComdoc (TVarChar, TDateTime, TVarChar, TDateTime, TVarChar, TDateTime, TVarChar, TDateTime, TVarChar, TVarChar, TVarChar, TVarChar, TDateTime, TVarChar);

CREATE OR REPLACE FUNCTION gpInsertUpdate_Movement_EDIComdoc(
    IN inOrderInvNumber      TVarChar  , -- Ќомер за€вки контрагента
    IN inOrderOperDate       TDateTime , -- ƒата за€вки контрагента
    IN inPartnerInvNumber    TVarChar  , -- Ќомер накладной у контрагента
    IN inPartnerOperDate     TDateTime , -- ƒата накладной у контрагента
    IN inInvNumberTax        TVarChar  , -- Ќомер налоговой накладной у контрагента (прив€зка возврата)
    IN inOperDateTax         TDateTime , -- ƒата налоговой накладной у контрагента (прив€зка возврата)
    IN inInvNumberSaleLink   TVarChar  , -- Ќомер накладной продажи контрагенту (прив€зка возврата) + добавлен дл€ продажи т.к. могут быть две за€вки с одинаковым номером
    IN inOperDateSaleLink    TDateTime , -- ƒата накладной продажи контрагенту (прив€зка возврата)
    IN inOKPO                TVarChar  , -- 
    IN inJurIdicalName       TVarChar  , --
    IN inDesc                TVarChar  , -- тип документа
    IN inGLNPlace            TVarChar  , --  од GLN - место доставки
    IN inComDocDate          TDateTime , -- ƒата за€вки контрагента
    IN inSession             TVarChar    -- сесси€ пользовател€
)                              
RETURNS TABLE (MovementId Integer, GoodsPropertyId Integer) --  лассификатор товаров
AS
$BODY$
   DECLARE vbMovementId      Integer;
   DECLARE vbGoodsPropertyId Integer;

   DECLARE vbIsInsert Boolean;
   DECLARE vbUserId Integer;
BEGIN
     -- проверка прав пользовател€ на вызов процедуры
     -- vbUserId:= lpCheckRight (inSession, zc_Enum_Process_InsertUpdate_Movement_EDIComdoc());
     vbUserId:= lpGetUserBySession (inSession);


     -- ћен€ем параметр
     inGLNPlace:= TRIM (inGLNPlace);

     -- ћен€ем параметр
     inDesc:= COALESCE ((SELECT MovementDesc.Code FROM MovementDesc WHERE Id = zc_Movement_Sale() AND inDesc = 'Sale')
                       , COALESCE ((SELECT MovementDesc.Code FROM MovementDesc WHERE Id = zc_Movement_ReturnIn() AND inDesc = 'Return')
                                 , (SELECT MovementDesc.Code FROM MovementDesc WHERE Id IN (zc_Movement_Sale(), zc_Movement_ReturnIn()) AND MovementDesc.Code = inDesc))
                       );

     IF inDesc IS NULL
     THEN
         RAISE EXCEPTION 'ќшибка в параметре.<%>', inDesc;
     END IF;

     -- ѕоиск документа в журнале EDI
     IF EXISTS (SELECT MovementDesc.Id FROM MovementDesc WHERE MovementDesc.Code = inDesc AND MovementDesc.Id = zc_Movement_Sale())
     THEN
         IF zfConvert_StringToBigInt (inGLNPlace)  = 0
         THEN inGLNPlace:= '';
         END IF;

         IF inGLNPlace <> ''
         THEN
              -- !!!так дл€ продажи!!! + !!!по точке доставки!!! + !!!inDesc!!!
              vbMovementId:= (SELECT Movement.Id
                              FROM Movement
                                   INNER JOIN MovementString AS MovementString_OKPO
                                                             ON MovementString_OKPO.MovementId =  Movement.Id
                                                            AND MovementString_OKPO.DescId = zc_MovementString_OKPO()
                                                            AND MovementString_OKPO.ValueData = inOKPO
                                   INNER JOIN MovementString AS MovementString_MovementDesc
                                                             ON MovementString_MovementDesc.MovementId =  Movement.Id
                                                            AND MovementString_MovementDesc.DescId = zc_MovementString_Desc()
                                                            AND MovementString_MovementDesc.ValueData IN (inDesc)
                                   INNER JOIN MovementString AS MovementString_GLNPlaceCode
                                                             ON MovementString_GLNPlaceCode.MovementId =  Movement.Id
                                                            AND MovementString_GLNPlaceCode.DescId = zc_MovementString_GLNPlaceCode()
                                                            AND MovementString_GLNPlaceCode.ValueData = inGLNPlace
                              WHERE Movement.DescId = zc_Movement_EDI()
                                AND Movement.InvNumber = inOrderInvNumber
                                AND Movement.OperDate BETWEEN (inPartnerOperDate - (INTERVAL '7 DAY')) AND (inPartnerOperDate + (INTERVAL '7 DAY'))
                              ORDER BY 1
                              LIMIT 1 -- !!!временно, т.к. пока непон€тно почему по€вилс€ > 1, пример - 4437188100 от '28.08.2015'!!!
                             );
              IF COALESCE (vbMovementId, 0) = 0
              THEN
              -- !!!так дл€ продажи!!! + !!!по точке доставки!!! + !!!zc_Movement_OrderExternal!!!
              vbMovementId:= (SELECT Movement.Id
                              FROM Movement
                                   INNER JOIN MovementString AS MovementString_OKPO
                                                             ON MovementString_OKPO.MovementId =  Movement.Id
                                                            AND MovementString_OKPO.DescId = zc_MovementString_OKPO()
                                                            AND MovementString_OKPO.ValueData = inOKPO
                                   INNER JOIN MovementString AS MovementString_MovementDesc
                                                             ON MovementString_MovementDesc.MovementId =  Movement.Id
                                                            AND MovementString_MovementDesc.DescId = zc_MovementString_Desc()
                                                            AND MovementString_MovementDesc.ValueData IN ((SELECT MovementDesc.Code FROM MovementDesc WHERE MovementDesc.Id = zc_Movement_OrderExternal()))
                                   INNER JOIN MovementString AS MovementString_GLNPlaceCode
                                                             ON MovementString_GLNPlaceCode.MovementId =  Movement.Id
                                                            AND MovementString_GLNPlaceCode.DescId = zc_MovementString_GLNPlaceCode()
                                                            AND MovementString_GLNPlaceCode.ValueData = inGLNPlace
                              WHERE Movement.DescId = zc_Movement_EDI()
                                AND Movement.InvNumber = inOrderInvNumber
                                AND Movement.OperDate BETWEEN (inPartnerOperDate - (INTERVAL '7 DAY')) AND (inPartnerOperDate + (INTERVAL '7 DAY'))
                             );
              END IF;

              IF vbMovementId <> 0
              THEN
                   -- !!!помен€ли у документа EDI признак!!!
                   PERFORM lpInsertUpdate_MovementString (zc_MovementString_Desc(), vbMovementId, (SELECT MovementDesc.Code FROM MovementDesc WHERE MovementDesc.Id = zc_Movement_Sale()));
              END IF;

         ELSE
              -- !!!так дл€ продажи!!! + !!!Ќ≈ важна точка доставки!!!
              vbMovementId:= (SELECT Movement.Id
                              FROM Movement
                                   INNER JOIN MovementString AS MovementString_OKPO
                                                             ON MovementString_OKPO.MovementId =  Movement.Id
                                                            AND MovementString_OKPO.DescId = zc_MovementString_OKPO()
                                                            AND MovementString_OKPO.ValueData = inOKPO
                                   INNER JOIN MovementString AS MovementString_MovementDesc
                                                             ON MovementString_MovementDesc.MovementId =  Movement.Id
                                                            AND MovementString_MovementDesc.DescId = zc_MovementString_Desc()
                                                            AND MovementString_MovementDesc.ValueData IN (inDesc, (SELECT MovementDesc.Code FROM MovementDesc WHERE MovementDesc.Id = zc_Movement_OrderExternal()))
                              WHERE Movement.DescId = zc_Movement_EDI()
                                AND Movement.InvNumber = inOrderInvNumber
                                AND Movement.OperDate BETWEEN (inPartnerOperDate - (INTERVAL '7 DAY')) AND (inPartnerOperDate + (INTERVAL '7 DAY'))
                             );

              IF vbMovementId <> 0
              THEN
                   -- !!!помен€ли у документа EDI признак!!!
                   PERFORM lpInsertUpdate_MovementString (zc_MovementString_Desc(), vbMovementId, (SELECT MovementDesc.Code FROM MovementDesc WHERE MovementDesc.Id = zc_Movement_Sale()));
              END IF;

         END IF;
     END IF;

     IF EXISTS (SELECT MovementDesc.Id FROM MovementDesc WHERE MovementDesc.Code = inDesc AND MovementDesc.Id = zc_Movement_ReturnIn())
     THEN
         -- !!!так дл€ возврата!!!
         vbMovementId:= (SELECT Movement.Id
                         FROM Movement
                              INNER JOIN MovementString AS MovementString_OKPO
                                                        ON MovementString_OKPO.MovementId =  Movement.Id
                                                       AND MovementString_OKPO.DescId = zc_MovementString_OKPO()
                                                       AND MovementString_OKPO.ValueData = inOKPO
                              INNER JOIN MovementString AS MovementString_InvNumberPartner
                                                        ON MovementString_InvNumberPartner.MovementId =  Movement.Id
                                                       AND MovementString_InvNumberPartner.DescId = zc_MovementString_Desc()
                                                       AND MovementString_InvNumberPartner.ValueData = inPartnerInvNumber
                              INNER JOIN MovementString AS MovementString_MovementDesc
                                                        ON MovementString_MovementDesc.MovementId =  Movement.Id
                                                       AND MovementString_MovementDesc.DescId = zc_MovementString_Desc()
                                                       AND MovementString_MovementDesc.ValueData = inDesc
                         WHERE Movement.DescId = zc_Movement_EDI()
                           AND Movement.InvNumber = inOrderInvNumber
                           AND Movement.OperDate BETWEEN (inPartnerOperDate - (INTERVAL '7 DAY')) AND (inPartnerOperDate + (INTERVAL '7 DAY'))
                        );
     END IF;

     -- определ€ем признак —оздание/ орректировка
     vbIsInsert:= COALESCE (vbMovementId, 0) = 0;

     IF COALESCE (vbMovementId, 0) = 0
     THEN
          -- сохранили <ƒокумент>
          vbMovementId := lpInsertUpdate_Movement (vbMovementId, zc_Movement_EDI(), inOrderInvNumber, inOrderOperDate, NULL);
          -- сохранили <ќ ѕќ>
          PERFORM lpInsertUpdate_MovementString (zc_MovementString_OKPO(), vbMovementId, inOKPO);

     END IF;

     -- сохранили  од GLN - место доставки
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_GLNPlaceCode(), vbMovementId, inGLNPlace);

     -- сохранили
     PERFORM lpInsertUpdate_MovementDate (zc_MovementDate_OperDatePartner(), vbMovementId, inPartnerOperDate);
     -- сохранили
     PERFORM lpInsertUpdate_MovementDate (zc_MovementDate_COMDOC(), vbMovementId, inComDocDate);

     -- сохранили
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_InvNumberPartner(), vbMovementId, inPartnerInvNumber);

     -- сохранили
     PERFORM lpInsertUpdate_MovementDate (zc_MovementDate_OperDateTax(), vbMovementId, inOperDateTax);
     -- сохранили
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_InvNumberTax(), vbMovementId, inInvNumberTax);

     -- сохранили ƒата накладной продажи контрагенту (прив€зка возврата)
     PERFORM lpInsertUpdate_MovementDate (zc_MovementDate_OperDateSaleLink(), vbMovementId, inOperDateSaleLink);
     -- сохранили  Ќомер накладной продажи контрагенту (прив€зка возврата)
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_InvNumberSaleLink(), vbMovementId, TRIM (inInvNumberSaleLink));

     -- сохранили
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_JurIdicalName(), vbMovementId, inJurIdicalName);
     -- сохранили
     PERFORM lpInsertUpdate_MovementString (zc_MovementString_Desc(), vbMovementId, inDesc);

     -- сохранили расчетные параметры
     vbGoodsPropertyId:= lpUpdate_Movement_EDIComdoc_Params (inMovementId       := vbMovementId
                                                           , inPartnerOperDate  := inPartnerOperDate
                                                           , inPartnerInvNumber := inPartnerInvNumber
                                                           , inOrderInvNumber   := inOrderInvNumber
                                                           , inOKPO             := inOKPO
                                                           , inIsCheck          := FALSE
                                                           , inUserId           := vbUserId);

     -- обнулили < ол-во у покуп.>, т.к. будем кол-ва суммировать
     PERFORM lpInsertUpdate_MovementItemFloat (zc_MIFloat_AmountPartner(), MovementItem.Id, 0)
     FROM MovementItem
     WHERE MovementItem.MovementId = vbMovementId
       AND MovementItem.DescId     = zc_MI_Master()
          ;



     -- пересчитали »тоговые суммы по накладной
     PERFORM lpInsertUpdate_MovementFloat_TotalSumm (vbMovementId);

     -- сохранили протокол
     PERFORM lpInsert_Movement_EDIEvents (vbMovementId, '«агрузка COMDOC из EDI', vbUserId);

     -- сохранили протокол
     PERFORM lpInsert_MovementProtocol (vbMovementId, vbUserId, vbIsInsert);

     -- –езультат
     RETURN QUERY 
     SELECT vbMovementId, vbGoodsPropertyId;

END;
$BODY$
  LANGUAGE plpgsql VOLATILE;

/*
 »—“ќ–»я –ј«–јЅќ“ »: ƒј“ј, ј¬“ќ–
               ‘елонюк ».¬.    ухтин ».¬.    лиментьев  .».
 16.04.15                         * 
 02.04.15                                        * add inGLNPlace
 07.08.14                                        * add calc inDesc
 07.08.14                                        * add inPartnerInvNumber := inPartnerInvNumber
 20.07.14                                        * ALL
 29.05.14                         *
*/

-- тест
-- SELECT * FROM gpInsertUpdate_Movement_EDI (ioId:= 0, inInvNumber:= '-1', inOperDate:= '01.01.2013', inFromId:= 1, inToId:= 2, inSession:= zfCalc_UserAdmin())
